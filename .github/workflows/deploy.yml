name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  railway:
    name: Railway Deploy (CLI)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Build client para garantir que a SPA exista em client/dist
      - name: Install client deps
        run: npm ci
        working-directory: client

      - name: Build client
        run: npm run build
        working-directory: client

      # Instalar deps do server e podar dev deps
      - name: Install server deps (npm install)
        run: npm install --no-audit --no-fund
        working-directory: server

      - name: Prune server dev deps
        run: npm prune --omit=dev
        working-directory: server

      - name: Ensure Railway CLI available (npx)
        run: echo "Using npx @railway/cli"

      - name: Deploy folder /server with Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID || '8bcb43b8-a1b6-4c45-a959-895254eac658' }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID || 'ead7c20a-82bf-4d26-9b39-c8e6bf02c229' }}
        run: |
          if [ -z "${RAILWAY_TOKEN}" ]; then
            echo "RAILWAY_TOKEN secret não está definido" && exit 1
          fi
          echo "Projeto: $RAILWAY_PROJECT_ID" && echo "Serviço: $RAILWAY_SERVICE_ID"
          # Configure contexto do projeto/serviço e fazer deploy do diretório server
          npx @railway/cli --version
          npx @railway/cli whoami || true
          npx @railway/cli link --project "$RAILWAY_PROJECT_ID" --service "$RAILWAY_SERVICE_ID"
          npx @railway/cli up --path server --no-confirm --detach
